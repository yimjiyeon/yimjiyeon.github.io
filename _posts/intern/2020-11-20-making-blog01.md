---
layout: post
title: "[ML/DL] 01.객체탐지 기반 아동그림심리 분석 서비스 개발"
subtitle: 개요
#date: '2021-07-15 11:45:51 +0900'
categories: intern_menu
tags: intern_menu
comments: true

#related_posts:
#  - category/_posts/study/2020-12-26-making-blog-02.md
#  - category/_posts/study/2020-12-26-making-blog-03.md
#published: false
---


객체 탐지 기반 아동 그림 심리분석 과제는 인공지능응용연구실에 인턴연구원으로 들어와 처음으로 주어진 과제였다.

어쩌면 지금 내가 객체 탐지/컴퓨터 비전 쪽에 흥미를 느끼게 된 계기가 될 수 있는 의미 있는 프로젝트였지 않았을까 생각한다. 과제를 받기 전까지만 해도 원자력이나 이와 관련된 데이터를 다룰 줄 알았던 나로서는 연구실에서 아동 그림 심리분석과 관련된 연구를 하고 있다는 것을 알고 조금 놀라기는 했었다. 하지만 인공지능이란 게 사실 어느 분야에서나 활용될 수 있기 때문에 다양한 시도를 해보는 것이 인공지능을 깊고 넓게 이해하는 데 더 도움이 될 수도 있겠다고 생각했다. 생각보다 다양하고 자유로운 분위기에서 연구를 하는 연구실에 좀 더 호감이 생겼던 것 같다. 또한 현재 AI 전문인력이 부족한 실정인데 고학력 전문연구원분들이 많이 계시는 정출연에서 AI 기술을 필요로 하는 여러 중소기업에 AI 솔루션을 제안 및 지원하면서 과학기술의 발전을 이루는 게 정말 좋은 취지인 것 같았다.

처음 아동 그림 심리분석 과제가 주어졌을 때 나는 이전까지 객체 탐지를 한 번도 해보지 않았기에 잘할 수 있을까 두려움도 조금 있었다. 하지만 딥러닝 분야에서 가장 흥미가 있었던 분야여서 이때다 싶어 열정적으로 강의를 듣고, 공부하고 코드짜고 실행하고를 반복했다. 또한, 실제 기술을 활용하려고 하는 나무와 숲 기업과 미팅을 통해 어떤 기술을 개발하고 싶은지 요구사항 수집하고, 진행 상황에 대해서 보고하고, 계속해서 협업하면서 실제 개발자가 된 듯한 실무경험을 할 수 있었던 게 너무 좋고 행복했다.

진행하면 할수록 재미와 성취감을 느꼈고, 어느 정도 인공지능 서버의 백 앤드 파이프라인을 구축하고 나서는 어떻게 하면 현재 개발한 앱에 새롭고 편리한 기술을 추가하고 알고리즘을 고도화할 수 있을까 하는 생각이 계속 따라다녔던 것 같다.


-  __아동 그림 심리분석 과제에서 진행 내용은 크게 다음과 같다.__

    - [1. 스케치 영역 검출 프로그램](#1.스케치-영역-검출-프로그램)
    - [2. detectron2 기반 아동 그림 객체탐지 모델개발](#2.detectron2-기반-아동-그림-객체탐지-모델개발)
    - [3. 색사용 정보추출](#3.색사용-정보추출)
    - [4. 그림 면적 및 위치 계산](#4.그림-면적-및-위치-계산)
    - [5. python flask를 이용한 API 인공지능 서버 개발](#5.python-flask를-이용한-API-인공지능-서버-개발)

## 1. 스케치 영역 검출 프로그램
---
모델 개발에 앞서 학습에 필요한 데이터를 구축하는 작업에 도움이 되는 스케치 영역 검출 프로그램을 구현했다. 아동 그림을 카메라로 찍은 사진 데이터는 스케치 영역 외에 불필요한 배경이 포함돼 있어 이를 제거하는 작업이 필요했다. 따라서 이미지를 원하는 형태에 맞게 crop 할 수 있는 프로그램을 찾아 추천을 해드렸지만 몇천 장의 그림 데이터를 하나씩 마우스로 작업하는 번거롭고 시간이 많이 소요된다는 문제가 있었다.

이와 같은 문제점을 파악하고 나는 해결하려는 방안을 모색했다. 그러던 중 패스트캠퍼스에서 명함 스캔하는 알고리즘 강의를 들었던 게 생각이 나서 참고하여 코드를 구현하기 시작했다. 하지만 비교적 단순한 형태와 단조로운 색을 가지고 있는 명함과 달리 아동 그림은 다양한 색과 그림자 등 주변 환경을 반영하고 있어 정확하게 외곽선을 검출하는 데 어려움이 있었다. 계속해서 전처리작업을 여러 가지 방향으로 수행하고 테스트해 보면서 아동 그림 데이터에 맞는 전처리작업을 최적화하였고 최대한 정확하게 스케치 외곽선을 검출할 수 있도록 구현했다.
또한 스케치 검출기능 이외에도 편리하게 데이터를 구축할 수 있도록 도움을 드리기 위해 폴더이름과 함께 실행하면 해당 폴더 내의 그림 데이터를 차례로 불러와서 일괄적으로 작업할 수 있도록 하였고, 몇 가지 마우스와 키보드 조작을 통해 좀 더 편리하게 작업할 수 있도록 하였다.

![SketchArea](/assets/SketchArea.png){: width="400" height="400}

비록 몇 줄 안되는 코드로 돌아가는 간단한 프로그램이었지만 협업 회사 담당자님께서 덕분에 빠르게 데이터 구축을 할 수 있었다고 해주셔서 보람을 느꼈었다.


## 2. detectron2-기반-아동그림객체탐지 모델개발
---

사실 학부생 때도 단일 python 파일 안에서 돌아가는 프로젝트 위주로 다루다 보니까 detectron2 처럼 여러 파일이 상호 작용하면서 실행되는 코드들을 이해하는 데 시간이 좀 걸렸다.

딥러닝은 학부생 때 졸업 연구를 진행하면서 생체신호를 이용해 MLP, CNN 모델을 학습 시켜본 경험이 있었다. 하지만 어떻게 보면 의료데이터라는 좀 생소하고 딱딱한 주제로 연구를 진행했다 보니 크게 감흥은 없었는데 여기서 실제 내가 생활 속에서 가끔 보았던 객체 탐지 기술을 활용한다고 하니까 뭔가 진짜 인공지능 연구를 하는 개발자가 된 것 같은 느낌이 들었다.

detectron2은 사용자의 목적에 따라 다양한 모델로 학습 및 추론 과정을 손쉽게 진행해볼 수 있으며 간단한 조작을 통해 일부 파라미터를 재설정하여 데이터에 맞게 최적화할 수 있는 장점이 있다. 이런 엄청난 장점 덕분에 object detection이라는 단어조차 생소했던 내가 객체 탐지 모델을 개발할 수 있지 않았나 싶다.



 ![detectron2](/assets/detectron2.png)
 ![layout](/assets/layout.png)

 처음 detectron2을 윈도우에 설치하는 것부터가 오류투성이였지만 구글링을 통해 하나씩 해결해나갔고 test 이미지를 통해 정상 작동되는 것을 확인한 순간 엄청난 희열을 느꼈다…ㅎㅎ

 코드 구조를 파악하는 데 시간이 걸렸지만 어느정도 detectron2 학습/평가/추론 엔진의 흐름을 알고나니 이후의 작업들은 수월하게 진행할 수 있었다.
 detectron2 내의 학습 엔진이 설정한 아동 그림학습데이터에 맞게 파싱 할 수 있도록 코드를 수정하였고 대표적인 객체 탐지 모델인 Faster-RCNN 을 기반으로 사전학습된 모델을 사용하여 Fine Tuning하여 사용하였다.

![캡처](/assets/캡처.PNG)

<!-- ### 기타 다른 사람들이 블로그를 하는 이유
​

- 공유 정신으로 스스로 사회에 기여하는 사람이 되고 싶어서

- 적극적인 사람 또는 열정을 가진 사람으로 보이기 위해
 -->

## 3. 색사용 정보추출
---
가장 수월하게 구현할 수 있을 줄 알았던 색상추출 알고리즘 구현이 생각보다 단순하지만은 않았고 코드를 몇 번이고 엎고 다시 짜고 하면서 아동 그림에 맞는 색상추출 알고리즘을 구현할 수 있었다. 아동 그림에서의 색상추출이 어려웠던 원인은 아마 스캔본과 달리 사진 파일의 경우 촬영 장소의 명도, 그림자, 피사체와의 거리 및 각도 등 촬영 공간에서의 환경 특성이 내재하여있어 그렇지 않았을까 생각을 한다.

하지만 나는 어떤 그림을 적용해도 강인하게 색상을 추출할 수 있는 알고리즘을 개발하기 위해 노력했다.
먼저 다양한 시도를 계획했으며 한가지씩 수행해 보면서 테스트를 진행해보았고 만약 일부 오류가 있다면 문제의 원인을 찾고 계속 안 되면 처음부터 다시 새로운 방법을 구색하는 방향으로 계속 접근했다.
처음에는 K-means 알고리즘을 활용해 색상을 군집화하여 색상을 추출하는 방향으로 접근했지만 적은 군집 수로 분류하면 정확도가 낮게 나오고, 반대로 군집 수의 개수를 늘려 설정하니 분석에 오래 걸린다는 문제가 있었다. 이 밖에도 오검출되는 색상이 많이 있었고, 여러 시도 끝에 몇 가지 전처리를 진행한 다음 HSV 색 공간에서 각 색상마다의 범위를 지정하는 방향으로 알고리즘을 개발하였다. 진행하면서 해결해야 할 문제점들이나 아이디어를 생각나는 대로 Notion에 정리하여 효율적으로 업무를 수행할 수 있도록 하였다.


​![Untitled](/assets/Untitled_da09pqwmq.png)
![Untitled (1)](/assets/Untitled%20(1)_isfcb6n25.png)
![Untitled (2)](/assets/Untitled%20(2)_e6hyed63i.png)
![Untitled (3)](/assets/Untitled%20(3)_spr03i6n4.png)

<!-- - 플랫폼 별 장점과 단점
| 서비스(플랫폼) | 장점 | 단점 |
| ---- | ---- | ---- |
| 네이버 Naver | -국내 클릭율(CTR) 우수 -상품 리뷰에 효과적 | -구글 등 해외 검색엔진 노출 문제 -커스터마이징 불가 (Markdown 사용불가 등) |
| 티스토리 Tistory | -커스터마이징 자유도 -깔끔한 디자인 -카운팅 등 다양한 기능 | -에디터 Wysiwyg 불편 -신규 제작 시 초대장이 필요 -기능의 파편화 |
| 벨로그 Velog | -한국사람이 개발 -국내 개발자들을 위한 플랫폼 -깔끔한 디자인 -브런치와 비슷 | -커스터마이징 불가 |
| 브런치 Brunch | -유사글 연결 기능 -깔끔한 디자인 -포스팅에만 집중하기 좋음 - 모바일 탁월 | -구글 등 해외 검색엔진 노출 문제 -커스터마이징 불가 -코드 삽입과 gist 지원 불가 |
| 구글 블로그 Blogger | - 검색노출 최고 | -검색 노출 외 좋은 점이 없다.
|워드프레스 Wordpress | -이지위그(Wysiwyg) 탁월 -APM 웹 프로그래밍 운영가능 | -유료 호스팅 운영 필요(AWS, CAFE24 등) -유지보수 상당한 노력 필요 |
| 지킬, Github 블로그 | -디자인,기능 거의 무제한 -비용 무료/속도 빠름 -개인DB화 관리 | -양방향 서비스 불가 -기능 연동 시 기술적 노하우 필요 | -->

## 4. 그림면적 및 위치 계산
---
이 작업은 크게 어려움 없이 진행을 했었다. 진짜 단순하게 아동 그림 탐지 모델을 통해 추론된 객체 탐지 bounding box 결과를 바탕으로 그림의 면적과 위치를 계산하였고 전체 그림의 크기 대비 그림에 사용한 면적의 비율과 무게중심을 계산하여 스케치 영역에서 그림이 상대적으로 어느 쪽으로 치우쳐있는지나 그림 사용 면적이 어느 정도 되는지 알 수 있도록 하였다.
​

![Untitled (4)](/assets/Untitled%20(4).png)


## 5. python flask를 이용한 API 인공지능 서버 개발
---

항상 앱이나 웹사이트를 사용하면서 어떻게 서버와 사용자가 원하는 정보를 주고받으며 알고리즘과 반응을 하게 되는지 궁금증이 있었는데 실제로 나무와 숲 아동 그림분석 인공지능 API 서버 구현을 해보면서 백엔드와 프론트엔드가 어떻게 데이터나 정보를 주고받고 할 수 있는지, 안정화된 서버를 구현하기 위해서는 어떻게 해야 하는지 등을 이해할 수 있었다.

내가 실제 인공지능을 활용할 수 있는 개발자가 된다면 데이터 구축, 모델 개발, 서버개발, 웹/앱 구현, 배포까지 혼자서 다 구현해서 인공지능 플랫폼을 뚝딱 만들 수 있는 풀스택 개발자가 되고 싶다는 생각이 들었다.

최종적으로 앱을 통해 아동 그림을 입력하면 API 서버를 통해 객체 탐지, 그림 면적 및 위치를 계산하고 색상분석을 차례로 수행하여 json 파일을 반환할 수 있도록 하였다.


![Untitled (5)](/assets/Untitled%20(5).png)
